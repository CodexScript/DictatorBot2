import { Message } from "discord.js";

const spotifyLinkRegex = new RegExp("https?://open.spotify.com/(track|album|artist)/.+", "gim");

export const name = "messageCreate";
export const once = false;
export const execute = async(message: Message) => {
	const matches = message.content.matchAll(spotifyLinkRegex);

	let i = 0;
	let resources = [];
	for (const match of matches) {
		resources.push(match);
		// Only evaluate the first 3 matches
		if (i >= 3) {
			break;
		}
		i++;
	}

	for (const match of resources) {
		const resourceType = match[0].split('/')[3];
		const resourceId = match[0].split('/')[4].split('?')[0];

		if (resourceType.toLowerCase() === 'track') {
			const track = await message.client.spotify.getTrack(resourceId);
			console.log(track.external_ids.isrc);
		} else if (resourceType.toLowerCase() === 'album') {
			const album = await message.client.spotify.getAlbum(resourceId);
			const track = await message.client.spotify.getTrack(album.tracks.items[album.tracks.items.length - 1].id);
			console.log(track.external_ids.isrc);
		} else if (resourceType.toLowerCase() === 'artist') {
			const artist = await message.client.spotify.getArtist(resourceId);
			console.log(artist.name);
		}
	}
}